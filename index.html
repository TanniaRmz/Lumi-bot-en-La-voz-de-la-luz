<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lumi-Bot | Alumbrado P√∫blico</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        /* --- ESTILOS CSS --- */
        
        /* === FONDO EXTERIOR (BODY) === */
        body {
            font-family: Arial, sans-serif;
            background-image: url('Fondo animado.avif'); 
            background-size: cover; 
            background-position: center; 
            background-attachment: fixed; 
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            overflow: hidden; /* Oculta el scroll durante la carga */
        }

        /* === PANTALLA DE CARGA (SPLASH SCREEN) === */
        #splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #128c7e; /* Color primario del bot */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease-out;
        }

        #splash-screen img {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
            animation: bounce 1s infinite alternate;
        }
        
        #splash-screen h1 {
            color: white;
            font-size: 2em;
            margin-bottom: 5px;
        }

        #splash-screen p {
            color: #dcf8c6;
            font-size: 1em;
        }

        /* Animaci√≥n del logo */
        @keyframes bounce {
            from {
                transform: scale(1);
            }
            to {
                transform: scale(1.05);
            }
        }
        
        /* === CONTENEDOR DEL CHAT (CHAT CONTAINER) === */
        .chat-container {
            width: 100%;
            max-width: 420px;
            height: 80vh;
            max-height: 700px;
            background-color: #f7f7f7; 
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative; 
            opacity: 0; /* Oculto al inicio */
            transition: opacity 0.5s ease-in;
        }

        /* === ESTILOS DEL CHAT (RESTO) === */
        .chat-header {
            background-color: #128c7e;
            color: white;
            padding: 15px;
            display: flex;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .header-avatar {
            background-color: #f0f0f0;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-right: 10px;
            overflow: hidden;
        }

        .header-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .header-info h3 {
            margin: 0;
            font-size: 1.1em;
        }

        .header-info p {
            margin: 0;
            font-size: 0.8em;
            opacity: 0.8;
        }

        .chat-body {
            flex-grow: 1;
            padding: 10px;
            overflow-y: auto;
            background-image: url('Luminarias aguascalientes.jpeg'); 
            background-size: cover; 
            background-position: center; 
            background-color: #e5ddd5; 
            display: flex;
            flex-direction: column;
        }

        .message-bubble {
            max-width: 80%;
            padding: 8px 12px;
            border-radius: 18px;
            margin-bottom: 8px;
            line-height: 1.4;
            position: relative;
            word-wrap: break-word;
        }

        .bot-message {
            background-color: #ffffff; 
            align-self: flex-start;
            border-bottom-left-radius: 2px;
            box-shadow: 0 1px 0.5px rgba(0, 0, 0, 0.13);
        }

        .user-message {
            background-color: #dcf8c6; 
            align-self: flex-end;
            border-bottom-right-radius: 2px;
            box-shadow: 0 1px 0.5px rgba(0, 0, 0, 0.13);
        }

        .message-time {
            display: block;
            font-size: 0.65em;
            color: #777;
            text-align: right;
            margin-top: 5px;
            line-height: 1;
        }
        
        .message-image-container {
            max-width: 100%;
            margin-bottom: 5px;
            border-radius: 8px;
            overflow: hidden;
        }

        .message-image {
            width: 100%;
            height: auto;
            display: block;
        }

        .chat-footer {
            padding: 8px;
            background-color: #f0f0f0;
            display: flex;
            align-items: center;
        }

        .chat-footer input[type="text"] {
            flex-grow: 1;
            border: none;
            padding: 12px 15px;
            border-radius: 20px;
            font-size: 1em;
            margin: 0 8px;
            box-shadow: 0 1px 0.5px rgba(0, 0, 0, 0.13);
        }

        .chat-footer button {
            background-color: #128c7e;
            color: white;
            border: none;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0 4px;
            transition: background-color 0.3s;
        }

        .chat-footer button:hover {
            background-color: #0e6c60;
        }

        #attach-button {
            background-color: transparent;
            color: #777;
            width: 44px;
            height: 44px;
            margin-left: 4px;
        }
        
        #attach-button:hover {
            color: #555;
            background-color: transparent;
        }

        #attach-button .material-icons {
            transform: rotate(45deg); 
        }

        #report-button {
            position: absolute;
            top: 15px; 
            right: 15px; 
            background-color: #dc3545; 
            color: white;
            border: none;
            border-radius: 8px; 
            width: 40px;
            height: 40px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            transition: background-color 0.3s;
            z-index: 10; 
        }

        #report-button:hover {
            background-color: #c82333; 
        }

        #report-button .material-icons {
            font-size: 24px; 
        }
    </style>
</head>
<body>

    <div id="splash-screen">
        <img src="Logo alumbrado publico cute.jpg" alt="Logo Lumi-Bot">
        <h1>Lumi-Bot</h1>
        <p>Iniciando servicio de alumbrado...</p>
    </div>

    <div class="chat-container" id="chat-container">
        
        <button id="report-button" onclick="startQuickReport()">
            <span class="material-icons">lightbulb_outline</span> 
        </button>

        <div class="chat-header">
            <div class="header-avatar">
                <img src="Logo alumbrado publico cute.jpg" alt="Lumi-Bot Logo">
            </div>
            <div class="header-info">
                <h3>Lumi-Bot</h3>
                <p>Alumbrado P√∫blico | La voz de la luz</p>
            </div>
        </div>

        <div class="chat-body" id="chat-body">
            </div>

        <div class="chat-footer">
            <button id="attach-button" onclick="document.getElementById('file-input').click();">
                <span class="material-icons">attach_file</span>
            </button>

            <input type="file" id="file-input" accept="image/*" style="display: none;">

            <input type="text" id="user-input" placeholder="Escribe tu pregunta o reporte..." onkeypress="handleKeyPress(event)">

            <button onclick="sendMessage()">
                <span class="material-icons">send</span>
            </button>
        </div>
    </div>

    <script>
        // --- L√ìGICA JAVASCRIPT ---
        const chatContainer = document.getElementById('chat-container');
        const chatBody = document.getElementById('chat-body');
        const userInput = document.getElementById('user-input');
        const fileInput = document.getElementById('file-input');
        const splashScreen = document.getElementById('splash-screen');
        const CHAT_STORAGE_KEY = 'lumi-bot-conversation';
        const FOLIO_COUNTER_KEY = 'lumi-bot-folio-counter'; 
        const DEFAULT_RESPONSE = "Lo siento, esa pregunta es nueva para m√≠. Intenta con **'hola'**, **'reportar'** o **'horario'** para guiarte.";

        // Estado: Almacena temporalmente la ubicaci√≥n para el reporte
        let currentReportLocation = null; 
        
        // Estado: Indica si el bot est√° esperando el folio o la direcci√≥n del usuario
        let waitingForFolio = false; 

        // Constante: Mensaje de estado detallado para el seguimiento (PASO 2)
        const DETAILED_STATUS_MESSAGE = "Estamos d√°ndole seguimiento a todas las solicitudes. Actualmente, tu reporte se encuentra en estado de **Verificaci√≥n en Campo** o **Reparaci√≥n Activa**.\n\nRecuerda que si ves una 'X' con cinta negra en la base, significa que fue **diagnosticada** y est√° en la lista de reparaciones prioritarias. ¬°El tiempo de atenci√≥n es de 24 a 72 horas h√°biles!";

        // --- OBJETO DE RESPUESTAS PERSONALIZADAS ---
        const RESPUESTAS = {
            "hola": {
                "variantes": ["hola", "holaaaa", "olis", "oli", "ola", "wenas", "buenos d√≠as", "buenas tardes"],
                "respuesta": "¬°Hola! Soy **Lumi-Bot**, tu asistente para Alumbrado P√∫blico. ¬øEn qu√© puedo ayudarte hoy?"
            },
            "qui√©n eres": {
                "variantes": ["qui√©n eres", "quien eres", "qu√© eres", "que eres"],
                "respuesta": "Soy un Chat-Bot dise√±ado para darte informaci√≥n y ayudarte a gestionar reportes del √°rea de Alumbrado P√∫blico. **¬°Mi misi√≥n es que tu calle brille!**"
            },
            "qu√© haces": {
                "variantes": ["qu√© haces", "que haces", "a qu√© te dedicas"],
                "respuesta": "Puedo responder dudas sobre reportes, servicios y horarios. Si quieres reportar una falla puedes escribir **'Reportar'** o si quieres saber del estado de tu reporte escribe **'Seguimiento'**."
            },
            "reportar": {
                "variantes": ["c√≥mo reporto una falla", "como reporto una falla", "quiero reportar una falla", "reportar", "reporte rapido"],
                "respuesta": "¬°Entendido! Vamos a generar un **Reporte R√°pido**. Primero, necesito tu ubicaci√≥n. El sistema ha solicitado permiso para usar tu GPS. Por favor, **acepta la solicitud de ubicaci√≥n** que aparece en tu navegador.\n\nSi ya lo hiciste, por favor, env√≠a un mensaje con la **direcci√≥n exacta** (calle, n√∫mero) y adjunta una **foto** (opcional)."
            },
            "d√≥nde puedo reportar": {
                "variantes": ["d√≥nde puedo reportar", "donde puedo reportar", "en d√≥nde reporto"],
                "respuesta": "Puedes reportar directamente aqu√≠ con Lumi-Bot, o si quieres hacerlo directo puedes llamar al n√∫mero oficial, hasta incluso puedes hacer tu reporte mas facil dentro del linnk Alumbrado."
            },
            "horario": {
                "variantes": ["cu√°l es tu horario", "cual es tu horario", "horario de atenci√≥n", "horario", "cual es el horario de alumbrado publico", "cual es el horario"],
                "respuesta": "El horario de atenci√≥n de Alumbardo Publico es de **Lunes a Domingo** y circulamos las **24 horas**."
            },
            "gracias": {
                "variantes": ["gracias", "muchas gracias", "te agradezco", "thanks", "thankos", "excelente dia"],
                "respuesta": "¬°De nada! Es un placer iluminar tu camino. "
            },
            "numero": {
                "variantes": ["numero", "¬øcual es el numero para reportar?", "cual es el numero", "cual es el numero para reportar"],
                "respuesta": "El n√∫mero oficial para reportes es el **072**. ¬°Gu√°rdalo! O si tienes problemas puedes llamar tambi√©n a este n√∫mero **449 910 1019**."
            },
            "tiempo de reparacion": {
                "variantes": ["tiempo de reparacion", "cuanto tardan", "cuanto tardan para reparar mi luminaria", "cuanto tardan para que hagan mi reporte", "cuanto se tarda el reporte"],
                "respuesta": "El tiempo estimado de reparaci√≥n suele ser de **24 a 72 horas h√°biles** despu√©s del reporte formal."
            },
            "link": {
                "variantes": ["cual link hablas", "cual es el link", "link", "link de alumbrado"],
                "respuesta": "Este es el link de reportes:<br> https://jonemoto24.github.io/Alumbrado-publico-de-Aguascalientes/ <br>Este reporte llegara directamente a Alumbrado Publico. "
            },
            
            "estado de reporte": {
                "variantes": [
                    "reportes", "quiero saber de mi reporte", "seguimiento", "estado de mi reporte", 
                    "reporte una lampara pero aun no sirve", "mi lampara aun no funciona", 
                    "mi lampara esta con una equis, porque?", "la lampara tiene una x con cinta, porque?", 
                    "la lampara que reporte sigue igual", "equis con cinta"
                ],

                "respuesta": "INICIAR SEGUIMIENTO: <br>Perfecto, voy a buscar tu reporte. Por favor, ind√≠came tu **n√∫mero de folio** o la **direcci√≥n exacta** que reportaste."
            },
            
            "lamparas nuevas": {
                "variantes": ["necesito una lampara nueva", "necesitamos que pongan una nueva lampara en esta calle", "quiero una lampara nueva", "quiero un cambio de lampara"],
                "respuesta": "La instalaci√≥n de una **nueva luminaria** requiere un proceso formal diferente al de una reparaci√≥n. Por favor, reporta el punto exacto y revisaremos la solicitud. Puedes hacer tu solicitud con el Reporte R√°pido."
            },
            "diferencia": {
                "variantes": ["ustedes que hacen", "exactamente que son?", "diferencia"],
                "respuesta": "Somos el √°rea de **Alumbrado P√∫blico**, encargados del mantenimiento y reparaci√≥n de las luminarias en las calles para mantener la iluminaci√≥n y seguridad de nuestra comunidad. **¬°Trabajamos por ti!**"
            },
            
            "lampara caida": {
                "variantes": ["se cay√≥ una l√°mpara, qu√© hago", "luminaria tirada", "poste ca√≠do", "lampara caida", "tengo una lampara de ustedes", "se a caido una lampara"],
                "respuesta": "¬°Es una emergencia! Por favor, evita o preocura no acercarte por riesgo el√©ctrico. Rep√≥rtalo de inmediato llamando al **072** y reporta aqu√≠ la direcci√≥n exacta para que el equipo de Alumbrado P√∫blico lo gestione."
            },
            "falla intermitente": {
                "variantes": ["la l√°mpara prende y apaga", "falla intermitente", "parpadea"],
                "respuesta": "Entendido. Esto es una **falla intermitente**. Por favor, genera un **Reporte R√°pido** indicando que la falla es intermitente para que el equipo lleve la refacci√≥n correcta."
            },
            "fotocelda": {
                "variantes": ["qu√© es una fotocelda", "para qu√© sirve el sensor", "fotocelda"],
                "respuesta": "La **fotocelda** es el sensor que detecta la luz natural. Su funci√≥n es encender la l√°mpara autom√°ticamente cuando oscurece y apagarla cuando amanece. Si tu l√°mpara est√° encendida de d√≠a, es probable que la fotocelda est√© da√±ada."
            },
            "tipo de lamparas": {
                "variantes": ["qu√© tipo de l√°mparas usan", "son LED o las viejas", "tipo de lamparas"],
                "respuesta": "Actualmente, estamos migrando a tecnolog√≠a **LED**, ya que es m√°s eficiente y ecol√≥gica. Si reportas una l√°mpara antigua, le daremos prioridad para el reemplazo con tecnolog√≠a LED."
            },
            "colores": {
                "variantes": ["por qu√© unas l√°mparas son amarillas y otras blancas", "lampara amarilla", "lampara blanca"],
                "respuesta": "Las l√°mparas **amarillas** son de tecnolog√≠a antigua. Las **blancas** son la nueva tecnolog√≠a LED. Todas las l√°mparas nuevas y las que se reparan se sustituyen por LED blanco para mejorar la visibilidad y la seguridad."
            },
            "pago": {
                "variantes": ["qui√©n paga el alumbrado p√∫blico", "hay que pagar por reportar", "pago"],
                "respuesta": "El servicio de alumbrado p√∫blico se cubre con los impuestos municipales. **Reportar una falla es totalmente gratuito** y es un servicio esencial para la comunidad."
            },
            "garantia": {
                "variantes": ["mi reporte tiene garant√≠a", "si vuelve a fallar", "garantia"],
                "respuesta": "S√≠. Todas las reparaciones y cambios de luminarias cuentan con una garant√≠a de **60 d√≠as naturales**. Si la misma l√°mpara falla dentro de ese per√≠odo, rep√≥rtala de nuevo y la atenderemos de forma inmediata."
            },
            "presencia": {
                "variantes": ["necesito estar en mi casa para que la arreglen", "es en la calle", "presencia"],
                "respuesta": "No, la reparaci√≥n se hace directamente en la calle. No es necesario que est√©s presente. Solo aseg√∫rate de proporcionar la **direcci√≥n exacta** y el **n√∫mero de poste** (si lo tiene) para que el equipo la localice sin problemas."
            },
            
        };

        function getCurrentTime() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            return `${hours}:${minutes}`;
        }

        function saveConversation() {
            // Guardamos solo si la pantalla de carga ya desapareci√≥
            if (chatContainer.style.opacity === '1') {
                localStorage.setItem(CHAT_STORAGE_KEY, chatBody.innerHTML);
            }
        }

        function appendMessage(text, sender, imageURL = null) {
            const time = getCurrentTime();
            const messageDiv = document.createElement('div');
            const formattedText = text.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            messageDiv.classList.add('message-bubble', sender === 'bot' ? 'bot-message' : 'user-message');

            let contentHTML = '';

            if (imageURL) {
                contentHTML += `
                    <div class="message-image-container">
                        <img src="${imageURL}" alt="Imagen adjunta" class="message-image">
                    </div>
                `;
            }

            contentHTML += `<span>${formattedText}</span>`;
            contentHTML += `<span class="message-time">${time}</span>`;

            messageDiv.innerHTML = contentHTML;
            chatBody.appendChild(messageDiv);

            chatBody.scrollTop = chatBody.scrollHeight;
            saveConversation();
        }

        function getBotResponse(userText) {
            const lowerCaseText = userText.toLowerCase().trim();

            // 1. CHEQUEO DE ESTADO: Si estamos esperando el folio (L√≥gica de 2 pasos)
            if (waitingForFolio) {
                if (lowerCaseText.length > 2) { 
                    waitingForFolio = false; 
                    return DETAILED_STATUS_MESSAGE; 
                }
            }
            
            // 2. EMPAREJAMIENTO NORMAL DE PALABRAS CLAVE
            for (const key in RESPUESTAS) {
                const item = RESPUESTAS[key];
                for (const variant of item.variantes) {
                    if (lowerCaseText.includes(variant.toLowerCase())) {
                        return item.respuesta;
                    }
                }
            }
            return DEFAULT_RESPONSE;
        }

        function processUserMessage(userText) {
            const botResponse = getBotResponse(userText);
            
            // 3. ACTIVACI√ìN DEL ESTADO: Si la respuesta contiene el marcador de inicio de seguimiento
            if (botResponse.startsWith("INICIAR SEGUIMIENTO:")) {
                waitingForFolio = true;
                const displayResponse = botResponse.substring("INICIAR SEGUIMIENTO:".length).trim();
                setTimeout(() => {
                    appendMessage(displayResponse, 'bot');
                }, 800);
            } else {
                // Para todas las dem√°s respuestas
                setTimeout(() => {
                    appendMessage(botResponse, 'bot');
                }, 800);
            }
        }

        function sendMessage() {
            const userText = userInput.value.trim();
            const file = fileInput.files[0];
            let imageURL = null;

            if (!userText && !file) {
                return;
            }

            if (file) {
                imageURL = URL.createObjectURL(file);
            }

            const messageToSend = userText || '[Imagen de Reporte Adjunta]';
            appendMessage(messageToSend, 'user', imageURL);

            if (userText || file) {
                const textToProcess = userText || "quiero reportar una falla"; 

                // L√ìGICA DE REPORTE FINAL: Se activa si ya se obtuvo la ubicaci√≥n y el usuario env√≠a datos.
                if (currentReportLocation && (textToProcess.length > 10 || file)) { 
                    const folio = getNextFolio();
                    const mapLink = `https://www.google.com/maps/search/?api=1&query=${currentReportLocation.latitude},${currentReportLocation.longitude}`;

                    const reportSummary = `
                        **‚úÖ REPORTE GENERADO CON √âXITO**
                        **Folio:** ${folio}
                        **Ubicaci√≥n GPS:** [Lat: ${currentReportLocation.latitude.toFixed(5)}, Lon: ${currentReportLocation.longitude.toFixed(5)}](${mapLink})
                        **Direcci√≥n/Descripci√≥n:** ${userText || 'Solo se proporcion√≥ ubicaci√≥n GPS.'}
                        **Adjunto:** ${file ? 'S√≠' : 'No'}
                        
                        Tu reporte ha sido registrado. Conserva el **Folio ${folio}** para dar seguimiento. ¬°Gracias por ayudarnos a iluminar tu comunidad!
                    `;
                    appendMessage(reportSummary, 'bot');
                    currentReportLocation = null; 
                } else {
                    processUserMessage(textToProcess);
                }
            }

            userInput.value = '';
            fileInput.value = ''; 
        }

        function handleKeyPress(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        }
        
        // --- L√ìGICA DE INICIO Y SPLASH SCREEN ---
        
        function sendBotInitialMessage() {
            const welcomeMessage = RESPUESTAS["hola"].respuesta + 
                "<br><br>¬øTe gustar√≠a hacer un **Reporte R√°pido**? Puedes usar el bot√≥n rojo üí° de arriba, o ¬øTienes una pregunta sobre **Horarios** o **Seguimiento**?";
                
            appendMessage(welcomeMessage, 'bot');
        }
        
        function loadConversation() {
            // Limpiar historial al cargar
            localStorage.removeItem(CHAT_STORAGE_KEY);
            chatBody.innerHTML = ''; 
        }

        /**
         * Funci√≥n principal para gestionar la carga y el mensaje de bienvenida.
         */
        function initializeApp() {
            // 1. Limpiar historial y chat
            loadConversation(); 

            // 2. Establecer el tiempo de duraci√≥n de la pantalla de carga (2000ms = 2 segundos)
            const splashDuration = 2000; 

            setTimeout(() => {
                // 3. Ocultar la pantalla de carga
                splashScreen.style.opacity = '0';
                
                // 4. Mostrar el contenedor del chat
                chatContainer.style.opacity = '1';
                
                // 5. Eliminar la pantalla de carga del DOM despu√©s de la transici√≥n
                setTimeout(() => {
                    splashScreen.style.display = 'none';
                    // 6. Enviar el primer mensaje del bot
                    sendBotInitialMessage();
                }, 500); // 500ms es la duraci√≥n de la transici√≥n CSS
                
            }, splashDuration);
        }
        
        // --- L√ìGICA DE GPS Y REPORTE (Sin cambios) ---
        
        function getNextFolio() {
            let folio = parseInt(localStorage.getItem(FOLIO_COUNTER_KEY) || '0', 10);
            folio++;
            localStorage.setItem(FOLIO_COUNTER_KEY, folio.toString());
            return `F-${String(folio).padStart(3, '0')}`;
        }

        function requestLocation() {
            currentReportLocation = null; 
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        currentReportLocation = {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude
                        };
                        const mapLink = `https://www.google.com/maps/search/?api=1&query=${currentReportLocation.latitude},${currentReportLocation.longitude}`;
                        
                        appendMessage(`‚úÖ **Ubicaci√≥n GPS Obtenida:** Latitud: ${currentReportLocation.latitude.toFixed(5)}, Longitud: ${currentReportLocation.longitude.toFixed(5)}.<br>([Ver en Mapa](${mapLink}))`, 'bot');
                        
                        appendMessage(`Ahora, por favor, escribe la **direcci√≥n exacta** (calle, n√∫mero, colonia) y adjunta una **foto** (opcional).`, 'bot');
                    },
                    (error) => {
                        let errorMessage = 'No fue posible obtener tu ubicaci√≥n GPS.';
                        if (error.code === error.PERMISSION_DENIED) {
                            errorMessage += '<br>Necesitas aceptar el permiso de ubicaci√≥n.';
                        } else {
                            errorMessage += `<br>Error: ${error.message}`;
                        }
                        appendMessage(`‚ö†Ô∏è **Alerta:** ${errorMessage}<br>Por favor, proporciona la direcci√≥n exacta manualmente.`, 'bot');
                    },
                    { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
                );
            } else {
                appendMessage("‚ö†Ô∏è **Error:** Tu navegador no soporta la geolocalizaci√≥n. Por favor, proporciona la direcci√≥n exacta manualmente.", 'bot');
            }
        }

        function startQuickReport() {
            appendMessage("Quiero hacer un Reporte R√°pido.", 'user');
            processUserMessage("reportar");
            requestLocation(); 
            userInput.focus();
        }

        // --- Inicializaci√≥n: Llama a la nueva funci√≥n de inicio ---
        window.onload = initializeApp;

    </script>

</body>
</html>